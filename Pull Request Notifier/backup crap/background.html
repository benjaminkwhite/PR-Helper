<!doctype html>
<html>

<head>
  <script type="text/javascript" src="jquery-2.0.3.min.js"></script>
  <script type="text/javascript" src="underscore-min.js"></script>
  <script type="text/javascript">
  var Fetcher, fetcher, interval;

  $.ajaxSetup({
    crossDomain: true,
    dataType: 'json'
  });

  Fetcher = (function() {
    Fetcher.prototype.totalPR = 0;

    Fetcher.prototype.accessToken = null;

    Fetcher.prototype.repositories = [];

    Fetcher.prototype.port = null;

    var msg;

    function Fetcher() {
      //    this.port = chrome.extension.connect({
      //      name: 'connection'
      //    });
      //    chrome.extension.onConnect.addListener((function(_this) {
      //      return function(port) {
      //        return port.onMessage.addListener(function(msg) {
      //          console.log(msg);
      //          if (msg.refresh != null) {
      //            return _this.fetch(port);
      //          }
      //        });
      //      };
      //    })(this));
    }

    Fetcher.prototype.fetch = function(port) {
      var dfds, dfds2;
      if (port == null) {
        port = null;
      }
      this.totalPR = 0;
      this.accessToken = localStorage.getItem('accessToken');
      this.apihost = 'https://api.github.com';
      this.repositories = JSON.parse(localStorage.getItem('repositories'));

      dfds = [];
      _(this.repositories).each((function(_this) {
        return function(repo) {
          return dfds.push($.ajax({
            type: 'get',
            url: _this.apihost + ("/repos/" + repo + "/pulls?access_token=" + _this.accessToken),
            success: function(data) {
              return _this.store(repo, data);
            },
            error: function() {
              debugger;
            }
          }));
        };
      })(this));

      return $.when.apply($, dfds).done((function(_this) {
        var self = _this

        return function() {
          var hiddenPRs, repos, totalPR;
          repos = JSON.parse(localStorage.getItem('repos')) || {};
          hiddenPRs = JSON.parse(localStorage.getItem('hiddenPRs')) || [];
          totalPR = _(repos).reduce(function(prev, prs) {
            var filtered;

            //console.log(prev);
            //console.log(prs);

            filtered = _(prs).filter(function(pr) {
              return !_(hiddenPRs).contains(pr.id);
            });
            return prev + filtered.length;
          }, 0);

          if (totalPR > 0) {
            comments = _(repos).reduce(function(prev, prs) {

              commentsData = _(prs).map(function(pr) {
                return {
                  id: pr.id,
                  url: pr.comments_url
                };

              });


              dfds2 = [];
              var temp = [];

              _(commentsData).each((function(self) {
                return function(commentsData) {
                  return dfds2.push($.ajax({
                    type: 'get',
                    url: commentsData.url,
                    success: function(data) {
                      temp = temp.concat(data);
                      return localStorage.setItem('comments', JSON.stringify(temp))
                    },
                    error: function() {
                      debugger;
                    }
                  }));
                };
              })(this));
            }, 0);

            //          chrome.browserAction.setBadgeText({
            //            text: "" + totalPR
            //          });
          } else {
            //          chrome.browserAction.setBadgeText({
            //            text: ''
            //          });
          }
          if (port) {
            return port.postMessage({
              success: true
            });
          }
        };
      })(this));
    };

    Fetcher.prototype.store = function(repo, data) {
      var repos, jsonText;
      repos = JSON.parse(localStorage.getItem('repos')) || {};
      repos[repo] = data;

      jsonText = JSON.stringify(repos);
      return localStorage.setItem('repos', jsonText);
    };

    return Fetcher;

  })();

  fetcher = new Fetcher;

  fetcher.fetch();

  interval = (localStorage.getItem('refreshRate') * 60000) || 300000;

  //localStorage.clear();

  setInterval(function() {
    return fetcher.fetch();
  }, interval);
  </script>
</head>

</html>
